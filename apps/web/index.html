<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#0b1020" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>English Radio MVP</title>
    <link rel="manifest" href="/manifest.webmanifest" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      :root {
        --bg: oklch(0.18 0.03 260);
        --panel: oklch(0.25 0.03 260);
        --panel-2: oklch(0.30 0.03 260);
        --text: oklch(0.95 0.01 260);
        --muted: oklch(0.78 0.02 260);
        --primary: oklch(0.72 0.17 255);
      }
      * { box-sizing: border-box; }
      body {
        font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: radial-gradient(circle at top, #18213f 0%, #0b1020 45%);
        color: var(--text);
        margin: 0;
        min-height: 100svh;
      }
      .wrap {
        max-width: 760px;
        margin: 0 auto;
        padding: 18px 14px calc(28px + env(safe-area-inset-bottom));
      }
      .title { margin: 8px 0 8px; font-size: clamp(1.25rem, 3.7vw, 1.8rem); }
      .muted { color: var(--muted); font-size: 13px; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 14px 0; }
      input {
        flex: 1;
        min-width: 150px;
        min-height: 44px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #3b4674;
        background: #101935;
        color: var(--text);
      }
      button {
        min-height: 44px;
        min-width: 92px;
        padding: 10px 14px;
        border: 0;
        border-radius: 12px;
        cursor: pointer;
        color: white;
        background: linear-gradient(135deg, #3765ff, #5b7bff);
        transition: transform 150ms ease-out, opacity 150ms ease-out;
      }
      button:active { transform: scale(0.97); }
      .secondary { background: #2b345f; }
      .card {
        margin-top: 12px;
        padding: 14px;
        border-radius: 14px;
        background: color-mix(in oklab, var(--panel), black 4%);
        border: 1px solid #2d3762;
      }
      .status-line { font-size: 14px; margin-bottom: 6px; }
      .sentence { font-size: 15px; line-height: 1.45; }
      audio { width: 100%; margin-top: 10px; }
      .pill {
        display: inline-block;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 99px;
        background: #2a335b;
        color: #dbe2ff;
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <h1 class="title">ğŸ§ English Radio</h1>
      <p class="muted">ëª¨ë°”ì¼ ì‹¤ì‹œê°„ ì²­ì·¨ ìµœì í™” Â· HLS ìŠ¤íŠ¸ë¦¬ë°</p>

      <div class="row">
        <input id="channel" value="beginner" aria-label="ì±„ë„ëª…" />
        <button id="playBtn">ì¬ìƒ</button>
        <button id="refreshBtn" class="secondary">ìƒíƒœ</button>
      </div>

      <div class="row">
        <input id="streamBase" placeholder="ìŠ¤íŠ¸ë¦¼ ë² ì´ìŠ¤ URL (ì„ íƒ)" />
        <button id="saveBaseBtn" class="secondary">ì €ì¥</button>
      </div>

      <audio id="audio" controls playsinline></audio>

      <section class="card" aria-live="polite">
        <div class="status-line"><span class="pill" id="pill">ëŒ€ê¸°</span></div>
        <div id="status" class="muted">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
        <div id="now" class="sentence muted">í˜„ì¬ ì¬ìƒ ì •ë³´ ì—†ìŒ</div>
      </section>
    </main>

    <script>
      const audio = document.getElementById('audio');
      const channelInput = document.getElementById('channel');
      const statusEl = document.getElementById('status');
      const nowEl = document.getElementById('now');
      const pillEl = document.getElementById('pill');
      let hls;
      let retryTimer;

      function setStatus(text, running = false) {
        statusEl.textContent = text;
        pillEl.textContent = running ? 'LIVE' : 'ëŒ€ê¸°';
      }

      const STREAM_BASE = localStorage.getItem('stream_base') || '';

      function manifestUrl(name) {
        return `${STREAM_BASE}/stream/${name}/live.m3u8`;
      }

      async function refreshNow() {
        const ch = channelInput.value.trim() || 'beginner';
        const res = await fetch(`/api/channels/${ch}/now`);
        const data = await res.json();
        setStatus(`ìƒíƒœ: ${data.running ? 'ì†¡ì¶œ ì¤‘' : 'ì •ì§€'} / manifest: ${data.manifestExists ? 'ìˆìŒ' : 'ì—†ìŒ'}`, data.running);
        nowEl.textContent = data.sentence ? `${data.trackTitle} â€” ${data.sentence}` : 'í˜„ì¬ ì¬ìƒ ì •ë³´ ì—†ìŒ';

        if ('mediaSession' in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: data.trackTitle || 'English Radio',
            artist: 'Chunshik English Radio',
            album: (ch + ' channel').toUpperCase()
          });
        }
      }

      function scheduleRetry() {
        clearTimeout(retryTimer);
        retryTimer = setTimeout(() => {
          play(true);
        }, 2500);
      }

      function play(isRetry = false) {
        const ch = channelInput.value.trim() || 'beginner';
        const src = manifestUrl(ch);

        if (hls) {
          hls.destroy();
          hls = null;
        }

        if (window.Hls && Hls.isSupported()) {
          hls = new Hls({
            enableWorker: true,
            lowLatencyMode: true,
            maxBufferLength: 20,
            liveSyncDurationCount: 3
          });
          hls.loadSource(src);
          hls.attachMedia(audio);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            audio.play().catch(() => {});
            setStatus(`ìƒíƒœ: ì¬ìƒ ì¤‘ (${src})`, true);
          });
          hls.on(Hls.Events.ERROR, (_evt, data) => {
            if (data?.fatal) {
              setStatus('ìƒíƒœ: ì¬ì—°ê²° ì‹œë„ ì¤‘...', false);
              scheduleRetry();
            }
          });
        } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
          audio.src = src;
          audio.play().catch(() => {});
          setStatus(`ìƒíƒœ: ì¬ìƒ ì¤‘ (${src})`, true);
          audio.addEventListener('error', () => {
            setStatus('ìƒíƒœ: ì¬ì—°ê²° ì‹œë„ ì¤‘...', false);
            scheduleRetry();
          }, { once: true });
        } else {
          setStatus('ë¸Œë¼ìš°ì €ê°€ HLSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', false);
        }

        if (!isRetry) refreshNow().catch(() => {});
      }


      const streamBaseInput = document.getElementById('streamBase');
      streamBaseInput.value = STREAM_BASE;
      document.getElementById('saveBaseBtn').addEventListener('click', () => {
        localStorage.setItem('stream_base', streamBaseInput.value.trim());
        setStatus('ìŠ¤íŠ¸ë¦¼ ë² ì´ìŠ¤ URL ì €ì¥ë¨. ì¬ìƒ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.', false);
      });

      document.getElementById('playBtn').addEventListener('click', () => play(false));
      document.getElementById('refreshBtn').addEventListener('click', () => refreshNow());

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }

      refreshNow().catch(() => {});
    </script>
  </body>
</html>
