name: Build and Upload HLS to R2

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "assets/**"
      - ".github/workflows/build-and-upload-hls.yml"

jobs:
  hls:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Build HLS files per channel
        run: |
          mkdir -p out/stream
          if [ ! -d assets ]; then
            echo "assets directory not found" && exit 1
          fi

          shopt -s nullglob
          channels=(assets/*)
          built_any=0

          for c in "${channels[@]}"; do
            [ -d "$c" ] || continue
            ch_name=$(basename "$c")
            files=("$c"/*.mp3 "$c"/*.m4a "$c"/*.aac "$c"/*.wav)
            real_files=()
            for f in "${files[@]}"; do
              [ -f "$f" ] && real_files+=("$f")
            done

            if [ ${#real_files[@]} -eq 0 ]; then
              echo "skip channel $ch_name (no audio files)"
              continue
            fi

            mkdir -p "out/stream/$ch_name"

            concat_list="out/${ch_name}_concat.txt"
            : > "$concat_list"
            for f in "${real_files[@]}"; do
              abs=$(realpath "$f")
              echo "file '$abs'" >> "$concat_list"
            done

            ffmpeg -y -re -f concat -safe 0 -i "$concat_list" \
              -c:a aac -b:a 128k -ar 44100 -ac 2 \
              -f hls -hls_time 6 -hls_list_size 10 -hls_flags delete_segments+append_list \
              -hls_segment_filename "out/stream/$ch_name/seg_%05d.ts" \
              "out/stream/$ch_name/live.m3u8"

            built_any=1
          done

          if [ "$built_any" -eq 0 ]; then
            echo "No channel assets found under assets/<channel>/*.{mp3,m4a,aac,wav}. Skip upload gracefully."
            mkdir -p out/stream
            echo "skip" > out/.skip_upload
          fi

      - name: Check upload precondition
        id: precheck
        run: |
          if [ -f out/.skip_upload ]; then
            echo "should_upload=false" >> $GITHUB_OUTPUT
          else
            echo "should_upload=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Cloudflare R2
        if: steps.precheck.outputs.should_upload == 'true'
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.CF_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
          r2-bucket: english-radio-stream
          source-dir: out
          destination-dir: .

      - name: Skip notice
        if: steps.precheck.outputs.should_upload == 'false'
        run: echo "No audio assets to build/upload. Job finished without failure."

      # duplicate upload block removed
